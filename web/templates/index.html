<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MT5 Data Downloader</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px;
        }
        .container {
            background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px; width: 100%; max-width: 600px;
        }
        h1 { color: #333; text-align: center; margin-bottom: 10px; font-size: 2em; }
        .subtitle { text-align: center; color: #666; margin-bottom: 30px; }
        .form-group { margin-bottom: 25px; }
        label { display: block; margin-bottom: 8px; color: #555; font-weight: 500; font-size: 0.95em; }
        select, input {
            width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px;
            font-size: 16px; transition: all 0.3s; background: white; color: #333;
        }
        select:focus, input:focus {
            outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .search-box { position: relative; margin-bottom: 10px; }
        .search-box input { font-size: 14px; }
        .timeframes { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .timeframe-item { position: relative; }
        .timeframe-item input[type="checkbox"] { position: absolute; opacity: 0; }
        .timeframe-item label {
            display: block; padding: 12px; background: #f5f5f5; border: 2px solid #e0e0e0;
            border-radius: 10px; text-align: center; cursor: pointer; transition: all 0.3s; margin: 0;
        }
        .timeframe-item input[type="checkbox"]:checked + label {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border-color: #667eea;
        }
        .btn {
            width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: 600;
            cursor: pointer; transition: all 0.3s; margin-top: 20px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4); }
        .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .select-all { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .select-all button {
            padding: 5px 15px; background: #6c757d; color: white; border: none;
            border-radius: 5px; cursor: pointer; font-size: 12px;
        }
        .select-all button:hover { background: #5a6268; }
        .loading { display: none; text-align: center; margin-top: 20px; }
        .loading.active { display: block; }
        .spinner {
            border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%;
            width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .results { display: none; margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; }
        .results.active { display: block; }
        .result-item {
            background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px;
            display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .result-info { flex: 1; }
        .result-info h4 { color: #333; margin-bottom: 5px; }
        .result-info p { color: #666; font-size: 0.9em; margin: 2px 0; }
        .download-btn {
            padding: 8px 16px; background: #28a745; color: white; border: none;
            border-radius: 5px; cursor: pointer; text-decoration: none; font-size: 14px;
        }
        .download-btn:hover { background: #218838; }
        .error {
            background: #f8d7da; color: #721c24; padding: 15px; border-radius: 10px;
            margin-top: 20px; display: none;
        }
        .error.active { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä MT5 Data Downloader</h1>
        <p class="subtitle">‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ó‡πà‡∏á‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô‡∏à‡∏≤‡∏Å MetaTrader 5</p>

        <form id="downloadForm">
            <div class="form-group">
                <label for="symbol">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏π‡πà‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏á‡∏¥‡∏ô / Symbol:</label>
                <div class="search-box">
                    <input type="text" id="symbolSearch" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ symbol..." onkeyup="filterSymbols()">
                </div>
                <select id="symbol" name="symbol" size="5" required>
                    <option value="">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ symbols...</option>
                </select>
            </div>

            <div class="form-group">
                <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Timeframe:</label>
                <div class="select-all">
                    <button type="button" onclick="selectAllTimeframes()">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                    <button type="button" onclick="deselectAllTimeframes()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                </div>
                <div class="timeframes">
                    <div class="timeframe-item">
                        <input type="checkbox" id="M1" name="timeframes" value="M1" checked>
                        <label for="M1">M1</label>
                    </div>
                    <div class="timeframe-item">
                        <input type="checkbox" id="M5" name="timeframes" value="M5" checked>
                        <label for="M5">M5</label>
                    </div>
                    <div class="timeframe-item">
                        <input type="checkbox" id="M15" name="timeframes" value="M15" checked>
                        <label for="M15">M15</label>
                    </div>
                    <div class="timeframe-item">
                        <input type="checkbox" id="M30" name="timeframes" value="M30">
                        <label for="M30">M30</label>
                    </div>
                    <div class="timeframe-item">
                        <input type="checkbox" id="H1" name="timeframes" value="H1" checked>
                        <label for="H1">H1</label>
                    </div>
                    <div class="timeframe-item">
                        <input type="checkbox" id="H4" name="timeframes" value="H4" checked>
                        <label for="H4">H4</label>
                    </div>
                    <div class="timeframe-item">
                        <input type="checkbox" id="D1" name="timeframes" value="D1">
                        <label for="D1">D1</label>
                    </div>
                </div>
            </div>

            <button type="submit" class="btn" id="downloadBtn">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </form>

        <button type="button" class="btn" id="analyzeBtn" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); margin-top: 10px;">
            üîç ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        </button>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å MT5...</p>
        </div>

        <div class="loading" id="analysisLoading">
            <div class="spinner"></div>
            <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        </div>

        <div class="error" id="error"></div>

        <div class="results" id="results">
            <h3>‚úÖ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h3>
            <div id="resultsList"></div>
        </div>

        <div class="results" id="analysisResults">
            <h3>üìä ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</h3>
            <div id="analysisContent" style="background: white; padding: 20px; border-radius: 10px; white-space: pre-wrap; line-height: 1.6;"></div>
        </div>
    </div>

    <script>
        let allSymbols = [];

        async function loadSymbols() {
            try {
                const response = await fetch('/api/symbols');
                const data = await response.json();
                if (data.error) { showError(data.error); return; }
                allSymbols = data.symbols;
                updateSymbolList(allSymbols);
            } catch (error) {
                showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ symbols ‡πÑ‡∏î‡πâ: ' + error.message);
            }
        }

        function updateSymbolList(symbols) {
            const select = document.getElementById('symbol');
            select.innerHTML = '';
            if (symbols.length === 0) {
                select.innerHTML = '<option value="">‡πÑ‡∏°‡πà‡∏û‡∏ö symbols</option>';
                return;
            }
            symbols.forEach(symbol => {
                const option = document.createElement('option');
                option.value = symbol.name;
                option.textContent = `${symbol.name} - ${symbol.description || symbol.path}`;
                select.appendChild(option);
            });
        }

        function filterSymbols() {
            const searchTerm = document.getElementById('symbolSearch').value.toUpperCase();
            const filtered = allSymbols.filter(symbol =>
                symbol.name.toUpperCase().includes(searchTerm) ||
                (symbol.description && symbol.description.toUpperCase().includes(searchTerm))
            );
            updateSymbolList(filtered);
        }

        function selectAllTimeframes() {
            document.querySelectorAll('input[name="timeframes"]').forEach(cb => cb.checked = true);
        }

        function deselectAllTimeframes() {
            document.querySelectorAll('input[name="timeframes"]').forEach(cb => cb.checked = false);
        }

        function showResults(results) {
            const resultsList = document.getElementById('resultsList');
            resultsList.innerHTML = '';
            results.forEach(result => {
                const item = document.createElement('div');
                item.className = 'result-item';
                item.innerHTML = `
                    <div class="result-info">
                        <h4>${result.filename}</h4>
                        <p>üìä ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${result.candles_count} ‡πÅ‡∏ó‡πà‡∏á‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô</p>
                        <p>üìÖ ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤: ${result.time_range}</p>
                        <p>üíπ ‡∏£‡∏≤‡∏Ñ‡∏≤: ${result.min_price.toFixed(5)} - ${result.max_price.toFixed(5)}</p>
                        <p>üü¢ ‡πÅ‡∏ó‡πà‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß: ${result.bullish_candles} | üî¥ ‡πÅ‡∏ó‡πà‡∏á‡πÅ‡∏î‡∏á: ${result.bearish_candles}</p>
                    </div>
                    <a href="/download/${result.filename}" class="download-btn">üíæ Download</a>
                `;
                resultsList.appendChild(item);
            });
            document.getElementById('results').classList.add('active');
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = '‚ö†Ô∏è ' + message;
            errorDiv.classList.add('active');
            setTimeout(() => { errorDiv.classList.remove('active'); }, 5000);
        }

        document.getElementById('downloadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const symbol = document.getElementById('symbol').value;
            const timeframes = Array.from(document.querySelectorAll('input[name="timeframes"]:checked')).map(cb => cb.value);

            if (!symbol) { showError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å symbol'); return; }
            if (timeframes.length === 0) { showError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å timeframe ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'); return; }

            document.getElementById('loading').classList.add('active');
            document.getElementById('downloadBtn').disabled = true;
            document.getElementById('error').classList.remove('active');
            document.getElementById('results').classList.remove('active');

            try {
                const response = await fetch('/api/download', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol: symbol, timeframes: timeframes })
                });
                const data = await response.json();

                if (data.success) {
                    showResults(data.results);
                    if (data.errors && data.errors.length > 0) {
                        showError('‡∏ö‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + data.errors.join(', '));
                    }
                } else {
                    showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (data.errors ? data.errors.join(', ') : 'Unknown error'));
                }
            } catch (error) {
                showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: ' + error.message);
            } finally {
                document.getElementById('loading').classList.remove('active');
                document.getElementById('downloadBtn').disabled = false;
            }
        });

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        async function analyzeData() {
            document.getElementById('analysisLoading').classList.add('active');
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('error').classList.remove('active');
            document.getElementById('analysisResults').classList.remove('active');

            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                const data = await response.json();

                if (data.success) {
                    const analysisContent = document.getElementById('analysisContent');
                    analysisContent.innerHTML = data.analysis_result;
                    document.getElementById('analysisResults').classList.add('active');
                } else {
                    showError('‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + data.error);
                }
            } catch (error) {
                showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå: ' + error.message);
            } finally {
                document.getElementById('analysisLoading').classList.remove('active');
                document.getElementById('analyzeBtn').disabled = false;
            }
        }

        // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
        document.getElementById('analyzeBtn').addEventListener('click', analyzeData);

        window.addEventListener('load', loadSymbols);
    </script>
</body>
</html>